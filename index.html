<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>영단어 단어장 v2</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f8f9fa; }
    .word { border: 1px solid #ccc; padding: 10px; margin: 5px 0; background: #fff; }
    input, button, select { padding: 6px; margin: 4px; }
  </style>
</head>
<body>
  <h1>📚 영단어 단어장 🦉🐨</h1>
  <input id="wordInput" placeholder="영어 단어 입력" />
  <button onclick="addWord()">단어 추가</button>
  <button onclick="clearWords()">초기화</button>
  <div id="wordList"></div>

  <div>
    <h2>🧠 테스트</h2>
    <input id="testCount" type="number" min="1" max="50" value="5" />
    <select id="testFilter">
      <option value="all">전체 단어</option>
      <option value="wrong">틀린 단어만</option>
    </select>
    <button onclick="startTest()">테스트 시작</button>
  </div>

  <div id="testArea"></div>

  <script>
    let words = JSON.parse(localStorage.getItem("words") || "[]");

    async function translate(text) {
      try {
        const r = await fetch("https://libretranslate.com/translate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ q: text, source: "en", target: "ko", format: "text" })
        });
        const d = await r.json();
        return d.translatedText || "";
      } catch {
        return "";
      }
    }

    async function fetchInfo(w) {
      try {
        const r = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${w}`);
        const d = await r.json();
        const def = d[0]?.meanings?.[0]?.definitions;
        if (!def?.length) throw new Error();
        const english = def[0].definition;
        let kor = await translate(english);
        if (!kor) kor = english; 
        return kor;
      } catch {
        return "뜻을 불러올 수 없습니다";
      }
    }

    async function addWord() {
      const w = document.getElementById("wordInput").value.trim().toLowerCase();
      if (!w) return alert("단어 입력!");
      if (words.some(x => x.word === w)) return alert("이미 등록됨!");

      const kor = await fetchInfo(w);
      words.push({ word: w, meaning: kor, correct: null });
      localStorage.setItem("words", JSON.stringify(words));
      document.getElementById("wordInput").value = "";
      render();
    }

    function clearWords() {
      if (confirm("초기화?")) {
        words = [];
        localStorage.removeItem("words");
        document.getElementById("testArea").innerHTML = "";
        render();
      }
    }

    function render() {
      const list = document.getElementById("wordList");
      list.innerHTML = "<h2>📘 등록단어</h2>";
      words.forEach(w => {
        const status = w.correct === true ? "✅ 맞음" :
                       w.correct === false ? "❌ 틀림" : "";
        list.innerHTML += `<div class="word">
          <strong>${w.word}</strong><br>
          뜻: ${w.meaning}<br>
          ${status}
        </div>`;
      });
    }

    function startTest() {
      const n = parseInt(document.getElementById("testCount").value) || 1;
      const f = document.getElementById("testFilter").value;
      let pool = f === "wrong" ? words.filter(w => w.correct === false) : [...words];
      if (!pool.length) return alert("시험할 단어 없음!");
      pool = pool.sort(() => 0.5 - Math.random()).slice(0, n);

      const t = document.getElementById("testArea");
      t.innerHTML = "";
      pool.forEach((w, i) => {
        t.innerHTML += `<div class="word">
          <strong>${w.word}</strong><br>
          뜻 입력: <input id="i${i}" data-ans="${w.meaning}" /><button onclick="check('i${i}','${w.word}')">확인</button>
          <div id="i${i}_r"></div>
        </div>`;
      });
    }

    function check(id, wd) {
      const ip = document.getElementById(id);
      const ans = ip.dataset.ans;
      const ok = ans.includes(ip.value.trim());
      const div = document.getElementById(id + "_r");
      const obj = words.find(w => w.word === wd);
      if (obj) obj.correct = ok;
      localStorage.setItem("words", JSON.stringify(words));
      div.innerHTML = ok
        ? `✅ 정답! 뜻: ${ans}`
        : `❌ 오답! 정답: ${ans}`;
      render();
    }

    render();
  </script>
</body>
</html>
