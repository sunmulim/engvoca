<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì˜ë‹¨ì–´ ë‹¨ì–´ì¥ v2</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f8f9fa; }
    .word { border: 1px solid #ccc; padding: 10px; margin: 5px 0; background: #fff; }
    input, button, select { padding: 6px; margin: 4px; }
  </style>
</head>
<body>
  <h1>ğŸ“š ì˜ë‹¨ì–´ ë‹¨ì–´ì¥ ğŸ¦‰ğŸ¨</h1>
  <input id="wordInput" placeholder="ì˜ì–´ ë‹¨ì–´ ì…ë ¥" />
  <button onclick="addWord()">ë‹¨ì–´ ì¶”ê°€</button>
  <button onclick="clearWords()">ì´ˆê¸°í™”</button>
  <div id="wordList"></div>

  <div>
    <h2>ğŸ§  í…ŒìŠ¤íŠ¸</h2>
    <input id="testCount" type="number" min="1" max="50" value="5" />
    <select id="testFilter">
      <option value="all">ì „ì²´ ë‹¨ì–´</option>
      <option value="wrong">í‹€ë¦° ë‹¨ì–´ë§Œ</option>
    </select>
    <button onclick="startTest()">í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
  </div>

  <div id="testArea"></div>

  <script>
    let words = JSON.parse(localStorage.getItem("words") || "[]");

    async function translate(text) {
      try {
        const r = await fetch("https://libretranslate.com/translate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ q: text, source: "en", target: "ko", format: "text" })
        });
        const d = await r.json();
        return d.translatedText || "";
      } catch {
        return "";
      }
    }

    async function fetchInfo(w) {
      try {
        const r = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${w}`);
        const d = await r.json();
        const def = d[0]?.meanings?.[0]?.definitions;
        if (!def?.length) throw new Error();
        const english = def[0].definition;
        let kor = await translate(english);
        if (!kor) kor = english; 
        return kor;
      } catch {
        return "ëœ»ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤";
      }
    }

    async function addWord() {
      const w = document.getElementById("wordInput").value.trim().toLowerCase();
      if (!w) return alert("ë‹¨ì–´ ì…ë ¥!");
      if (words.some(x => x.word === w)) return alert("ì´ë¯¸ ë“±ë¡ë¨!");

      const kor = await fetchInfo(w);
      words.push({ word: w, meaning: kor, correct: null });
      localStorage.setItem("words", JSON.stringify(words));
      document.getElementById("wordInput").value = "";
      render();
    }

    function clearWords() {
      if (confirm("ì´ˆê¸°í™”?")) {
        words = [];
        localStorage.removeItem("words");
        document.getElementById("testArea").innerHTML = "";
        render();
      }
    }

    function render() {
      const list = document.getElementById("wordList");
      list.innerHTML = "<h2>ğŸ“˜ ë“±ë¡ë‹¨ì–´</h2>";
      words.forEach(w => {
        const status = w.correct === true ? "âœ… ë§ìŒ" :
                       w.correct === false ? "âŒ í‹€ë¦¼" : "";
        list.innerHTML += `<div class="word">
          <strong>${w.word}</strong><br>
          ëœ»: ${w.meaning}<br>
          ${status}
        </div>`;
      });
    }

    function startTest() {
      const n = parseInt(document.getElementById("testCount").value) || 1;
      const f = document.getElementById("testFilter").value;
      let pool = f === "wrong" ? words.filter(w => w.correct === false) : [...words];
      if (!pool.length) return alert("ì‹œí—˜í•  ë‹¨ì–´ ì—†ìŒ!");
      pool = pool.sort(() => 0.5 - Math.random()).slice(0, n);

      const t = document.getElementById("testArea");
      t.innerHTML = "";
      pool.forEach((w, i) => {
        t.innerHTML += `<div class="word">
          <strong>${w.word}</strong><br>
          ëœ» ì…ë ¥: <input id="i${i}" data-ans="${w.meaning}" /><button onclick="check('i${i}','${w.word}')">í™•ì¸</button>
          <div id="i${i}_r"></div>
        </div>`;
      });
    }

    function check(id, wd) {
      const ip = document.getElementById(id);
      const ans = ip.dataset.ans;
      const ok = ans.includes(ip.value.trim());
      const div = document.getElementById(id + "_r");
      const obj = words.find(w => w.word === wd);
      if (obj) obj.correct = ok;
      localStorage.setItem("words", JSON.stringify(words));
      div.innerHTML = ok
        ? `âœ… ì •ë‹µ! ëœ»: ${ans}`
        : `âŒ ì˜¤ë‹µ! ì •ë‹µ: ${ans}`;
      render();
    }

    render();
  </script>
</body>
</html>
